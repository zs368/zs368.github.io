<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>MySQL - OxO</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="zs" /><meta name="description" content="" /><meta name="keywords" content="mysql, sql" />






<meta name="generator" content="Hugo 0.78.0 with theme even" />


<link rel="canonical" href="https://zs368.github.io/post/mysql/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.78f8f17bab244b9ee62ad16480c9584d5fc2db06ae20681d1ca225cefd80767c.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="MySQL" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zs368.github.io/post/mysql/" />
<meta property="article:published_time" content="2020-10-24T11:42:21+08:00" />
<meta property="article:modified_time" content="2020-10-24T11:42:21+08:00" />
<meta itemprop="name" content="MySQL">
<meta itemprop="description" content="">
<meta itemprop="datePublished" content="2020-10-24T11:42:21+08:00" />
<meta itemprop="dateModified" content="2020-10-24T11:42:21+08:00" />
<meta itemprop="wordCount" content="3677">



<meta itemprop="keywords" content="sql,mysql," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MySQL"/>
<meta name="twitter:description" content=""/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">zs368</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/info/">
        <li class="mobile-menu-item">Info</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">zs368</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/info/">Info</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">MySQL</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-10-24 </span>
        <div class="post-category">
            <a href="/categories/%E7%BC%96%E7%A8%8B/"> 编程 </a>
            </div>
          <span class="more-meta"> 3677 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#设计理念">设计理念</a></li>
        <li><a href="#引擎">引擎</a></li>
        <li><a href="#索引">索引</a></li>
        <li><a href="#语句">语句</a></li>
        <li><a href="#主从复制">主从复制</a></li>
        <li><a href="#分库分表">分库分表</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h3 id="设计理念">设计理念</h3>
<h4 id="三范式">三范式</h4>
<ul>
<li><strong>原子性</strong>，即列不能够再分成其他几列</li>
<li><strong>惟一性</strong>，要求记录有惟一标识，即实体的惟一性</li>
<li><strong>冗余性</strong>，要求任何字段不能由其他字段派生出来，即不存在传递依赖</li>
</ul>
<h4 id="事务">事务</h4>
<ul>
<li>Atomicity（原子性）：一个事务（transaction）中的所有操作，或者全部完成，或者全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。即，事务不可分割、不可约简。</li>
<li>Consistency（一致性）：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设约束、触发器、级联回滚等。</li>
<li>Isolation（隔离性）：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括未提交读（Read uncommitted）、提交读（read committed）、可重复读（repeatable read）和串行化（Serializable）。</li>
<li>Durability（持久性）：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</li>
</ul>
<h3 id="引擎">引擎</h3>
<h4 id="innodb存储引擎">InnoDB存储引擎</h4>
<p>nnoDB是事务型数据库的首选引擎，支持事务安全表（ACID），支持行锁定和外键。</p>
<p>主键索引：</p>
<p><img src="/img/mysql_2.png" alt=""></p>
<p>辅助索引：</p>
<p><img src="/img/mysql_3.png" alt=""></p>
<p>使用 <strong>InnoDB存储引擎</strong> MySQL将创建一个名为 <code>ibdata1 </code>的10MB大小的自动扩展数据文件，以及两个名为<code>ib_logfile0</code>和<code>ib_logfile1</code>的5MB大小的日志文件</p>
<blockquote>
<p>InnoDB 主键索引中既存储了主健值，又存储了行数据</p>
<p>辅助索引是在叶子节点中保存主键值，通过这个主键值来回表查询到一条完整记录</p>
</blockquote>
<ul>
<li>灾难恢复性好</li>
<li>支持事务</li>
<li>使用行级锁</li>
<li>支持外键关联</li>
<li>支持热备份</li>
<li>对于InnoDB引擎中的表，其数据的物理组织形式是簇表（Cluster Table），主键索引和数据是在一起的，数据按主键的顺序物理分布</li>
<li>实现了缓冲管理，不仅能缓冲索引也能缓冲数据，并且会自动创建散列索引以加快数据的获取</li>
<li>支持热备份</li>
</ul>
<h4 id="myisam引擎">MyISAM引擎</h4>
<p>MyISAM基于ISAM存储引擎，并对其进行扩展，拥有较高的插入、查询速度，但不支持事务。</p>
<p><img src="/img/mysql_1.png" alt=""></p>
<p>使用<strong>MyISAM引擎</strong>创建数据库，将产生3个文件：<code>.frm</code>文件存储表定义、<code>.MYD(MYData)</code> 文件存储数据、 <code>.MYI(MYIndex)</code> 文件存储索引</p>
<blockquote>
<p>索引文件仅保存记录所在页的指针（物理位置），通过这些指针来读取页，进而读取被索引的行，同时，每个叶子也保存了指向下一个叶子的指针，从而方便叶子节点的范围遍历。</p>
<p>在 MyISAM 中，主键索引和辅助索引在结构上没有任何区别（主键索引要求 key 是唯一的）</p>
</blockquote>
<ul>
<li>不支持事务</li>
<li>使用表级锁，并发性差</li>
<li>主机宕机后，MyISAM表易损坏，灾难恢复性不佳</li>
<li>可以配合锁，实现操作系统下的复制备份、迁移</li>
<li>只缓存索引，数据的缓存是利用操作系统缓冲区来实现的。可能引发过多的系统调用且效率不佳</li>
<li>数据紧凑存储，因此可获得更小的索引和更快的全表扫描性能</li>
</ul>
<h4 id="memory存储引擎">MEMORY存储引擎</h4>
<p>MEMORY存储引擎将表中的数据存储到内存中，未查询和引用其他表数据提供快速访问。</p>
<ul>
<li>MEMORY表的每个表可以有多达32个索引，每个索引16列，以及500字节的最大键长度</li>
<li>MEMORY存储引擎执行HASH和BTREE缩影</li>
<li>可以在一个MEMORY表中有非唯一键值</li>
<li>MEMORY表使用一个固定的记录长度格式</li>
<li>MEMORY不支持BLOB或TEXT列</li>
<li>MEMORY支持AUTO_INCREMENT列和对可包含NULL值的列的索引</li>
<li>MEMORY表在所由客户端之间共享（就像其他任何非TEMPORARY表）</li>
<li>MEMORY表内存被存储在内存中，内存是MEMORY表和服务器在查询处理时的空闲中，创建的内部表共享</li>
<li>当不再需要MEMORY表的内容时，要释放被MEMORY表使用的内存，应该执行<code>DELETE FROM</code>或<code>TRUNCATE TABLE</code>，或者删除整个表（使用DROP TABLE）</li>
</ul>
<h3 id="索引">索引</h3>
<p><strong>索引是帮助数据库高效获取数据的数据结构。</strong></p>
<ul>
<li>
<p>应用层次</p>
<ul>
<li>普通索引：即一个索引只包含单个列，一个表可以有多个单列索引</li>
<li>唯一索引：索引列的值必须唯一，但允许有空值</li>
<li>复合索引：一个索引包含多个列</li>
</ul>
</li>
<li>
<p>表记录的排列顺序和索引的排列顺序是否一致</p>
<ul>
<li>
<p>聚集索引：顺序一致，以主键创建的索引</p>
<blockquote>
<p>在叶子节点存储的是表中的数据。查询速度快，新增速度慢（每次插入要重排）。</p>
</blockquote>
</li>
<li>
<p>非聚集索引：顺序不一致，以非主键创建的索引（也叫做二级索引）</p>
<blockquote>
<p>在叶子节点存储的是主键和索引列，使用非聚集索引查询数据时，需要拿到叶子上的主键再去表中查找数据（回表）</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>储存结构</p>
<ul>
<li>
<p>Btree 索引（B+tree，B-tree)：MySQL采用 B+ 树</p>
</li>
<li>
<p>哈希索引：本质上就是把键值换算成新的哈希值，根据这个哈希值来定位</p>
</li>
<li>
<p>full-index 全文索引</p>
</li>
<li>
<p>RTree</p>
</li>
</ul>
</li>
</ul>
<h4 id="btree-索引">Btree 索引</h4>
<p><strong>B 树（B- 树）</strong></p>
<ul>
<li>关键字分布在整棵树的所有节点。</li>
<li>任何一个关键字 <strong>出现且只出现在一个节点中</strong>。</li>
<li>搜索有可能在 <strong>非叶子节点</strong> 结束。</li>
<li>其搜索性能等价于在关键字全集内做一次二分查找</li>
</ul>
<p><img src="/img/mysql_4.png" alt=""></p>
<p><strong>B+ 树</strong></p>
<ul>
<li>非叶子节点的子树指针与关键字个数相同。</li>
<li>非叶子节点的子树指针 P[i]，指向关键字属于 <strong>[k[i],K[i+1])</strong> 的子树（<strong>注意：区间是前闭后开</strong>)。</li>
<li><strong>为所有叶子节点增加一个链指针</strong>。</li>
<li><strong>所有关键字都在叶子节点出现</strong>。</li>
</ul>
<p><img src="/img/mysql_5.png" alt=""></p>
<p><strong>相对 B 树，B+ 树做索引的优势</strong></p>
<ul>
<li><strong>B+ 树的磁盘读写代价更低</strong> （内部没有指向关键字具体信息的指针）</li>
<li><strong>B+ 树的查询效率更加稳定</strong> （数据都在叶子节点，每次查询路径长度一致）</li>
<li><strong>B+ 树只需要去遍历叶子节点就可以实现整棵树的遍历</strong></li>
</ul>
<p>MongoDB 的索引为什么选择 B 树，而 MySQL 的索引是 B+ 树？</p>
<p>因为 MongoDB 不是传统的关系型数据库，而是以 Json 格式作为存储的 NoSQL 非关系型数据库，目的就是高性能、高可用、易扩展。摆脱了关系模型，所以 <strong>范围查询和遍历查询的需求就没那么强烈了</strong>。</p>
<h4 id="哈希索引">哈希索引</h4>
<p>哈希索引就是采用一定的哈希算法，只需一次哈希算法即可立刻定位到相应的位置，速度非常快。</p>
<p>缺点：</p>
<ul>
<li>没办法利用索引完成排序</li>
<li>不能进行多字段查询</li>
<li>在有大量重复键值的情况下，哈希索引的效率也是极低的（出现哈希碰撞问题）</li>
<li>不支持范围查询</li>
</ul>
<h4 id="索引失效">索引失效</h4>
<ul>
<li>违反最左匹配原则</li>
<li>在索引列上做任何操作</li>
<li>使用不等于（!= 、&lt;&gt;）</li>
<li>like 中以通配符开头 (’%abc’)</li>
<li>字符串不加单引号索引失效</li>
<li>or 连接索引失效</li>
<li>order by  或  group by  导致的违反最左前缀法则</li>
</ul>
<h3 id="语句">语句</h3>
<p><strong>查询语句执行流程：</strong></p>
<ol>
<li>应用程序发送SQL到服务端</li>
<li>查询缓存</li>
<li>查询优化处理
<ol>
<li><strong>解析 SQL</strong>：生成解析树，验证关键字如 select,where,left join 等）是否正确</li>
<li><strong>预处理</strong>：进一步检查解析树是否合法</li>
<li><strong>优化 SQL</strong>：<strong>决定使用哪个索引</strong>，或者在多个表相关联的时候决定表的连接顺序</li>
</ol>
</li>
<li>将 SQL 语句转成执行计划</li>
<li>将查询结果返回客户端</li>
</ol>
<h3 id="主从复制">主从复制</h3>
<p><strong>用途：</strong></p>
<ul>
<li>读写分离：防止锁表后无法读表</li>
<li>做数据的热备</li>
<li>架构的扩展</li>
</ul>
<p><strong>类型：</strong></p>
<p>MySQL默认使用基于语句的复制，当基于语句的复制会引发问题的时候就会使用基于行的复制，MySQL会自动进行选择。</p>
<ul>
<li>基于SQL语句的复制（SBR）</li>
<li>基于行的复制（RBR）</li>
<li>混合模式复制（MBR）</li>
<li>全局事务标识符 GTID（GTID）</li>
</ul>
<p><strong>过程：</strong></p>
<ol>
<li>在Slave服务器上执行start slave命令开启主从复制开关，开始进行主从复制。</li>
<li>此时，Slave服务器的IO线程会通过在master上已经授权的复制用户权限请求连接Master服务器，并请求从执行binlog日志文件中的指定位置（日志文件名和位置就是在配置主从复制服务时执行change master命令指定的）之后开始发送binlog日志内容。</li>
<li>Master服务器接收来自Slave服务器的IO线程的请求后，其上负责复制的IO线程会根据Slave服务器的IO线程请求的信息分批读取指定binlog日志文件指定位置之后的binlog日志信息，然后返回给Slave端的IO线程。返回的信息中除了binlog日志内容外，还有在Master服务器端记录的IO线程。返回的信息中除了binlog中的下一个指定更新位置。</li>
<li>当Slave服务器的IO线程获取到Master服务器上IO线程发送的日志内容、日志文件及位置点后，会将binlog日志内容依次写到Slave端自身的Relay Log（即中继日志）文件（Mysql-relay-bin.xxx）的最末端，并将新的binlog文件名和位置记录到master-info文件中，以便下一次读取master端新binlog日志时能告诉Master服务器从新binlog日志的指定文件及位置开始读取新的binlog日志内容</li>
<li>Slave服务器端的SQL线程会实时检测本地Relay Log 中IO线程新增的日志内容，然后及时把Relay LOG 文件中的内容解析成sql语句，并在自身Slave服务器上按解析SQL语句的位置顺序执行应用这样sql语句，并在relay-log.info中记录当前应用中继日志的文件名和位置点</li>
</ol>
<h3 id="分库分表">分库分表</h3>
<p><strong>问题：</strong></p>
<ul>
<li>用户请求量太大</li>
<li>单库太大</li>
<li>单表太大</li>
</ul>
<p><strong>拆分方法：</strong> 分库分表的顺序应该是先垂直分，后水平分</p>
<ul>
<li>
<p>垂直拆分：</p>
<ul>
<li>垂直分表：大表拆小表，基于列字段进行的</li>
<li>垂直分库：对一个系统中的不同业务进行拆分</li>
</ul>
</li>
<li>
<p>水平拆分：</p>
<ul>
<li>
<p>水平分表：针对数据量巨大的单张表，按照某种规则（RANGE,HASH取模等），切分到多张表里面去</p>
</li>
<li>
<p>水平分库分表：将单张表的数据切分到多个服务器上去，每个服务器具有相应的库与表，只是表中数据集合不同</p>
</li>
<li>
<p>规则：</p>
<ul>
<li>RANGE</li>
<li>HASH取模</li>
<li>地理区域</li>
<li>时间</li>
</ul>
</li>
</ul>
</li>
</ul>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/sql/">sql</a>
          <a href="/tags/mysql/">mysql</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E9%AB%98%E6%80%A7%E8%83%BDmysql/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">高性能MySQL</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8Aphp%E5%AE%9E%E7%8E%B0/">
            <span class="next-text nav-default">数据结构及PHP实现</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://github.com/zs368/" class="iconfont icon-github" title="github"></a>
      <a href="http://bilibili.com" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://zs368.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">zs368</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>








</body>
</html>
